<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PPS AI Intelligence</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7fa; font-family: 'Pretendard', sans-serif; font-size: 11px; }
        .header-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .github-config { background: #e7f5ff; padding: 15px; border-radius: 8px; border: 1px solid #74c0fc; margin-bottom: 15px; }
        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: auto; max-height: 520px; position: relative; }
        
        /* ëª¨ë“  ì»¬ëŸ¼ ê°€ìš´ë° ì •ë ¬ ì ìš© */
        .table th, .table td { text-align: center !important; vertical-align: middle !important; white-space: nowrap; }
        .table thead th { background: #343a40; color: white; position: sticky; top: 0; z-index: 20; }
        .sticky-col { position: sticky; left: 0; background: white !important; z-index: 10; border-right: 2px solid #dee2e6 !important; }
        
        .summary-box { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6; font-weight: 800; font-size: 13px; }
        .nav-tabs .nav-link { font-weight: 800; color: #495057; border: none; padding: 10px 20px; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
        .group-set { background-color: #f8fafc; font-weight: 600; }
        .badge-urgent { background-color: #fa5252; color: white; padding: 3px 6px; border-radius: 4px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .month-selector { display: flex; align-items: center; gap: 10px; background: #fff; padding: 5px 15px; border-radius: 8px; border: 2px solid #0d6efd; }
        .month-display { font-size: 14px; font-weight: 800; color: #0d6efd; min-width: 90px; text-align: center; }
        .btn-month { border: none; background: none; color: #0d6efd; font-size: 18px; font-weight: bold; cursor: pointer; }
        .load-more-btn { width: 100%; padding: 10px; background: #f8f9fa; border: 1px dashed #dee2e6; color: #6c757d; font-weight: bold; cursor: pointer; margin-top: 10px; display: none; }
        .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center; flex-direction:column; }
        .compare-box { font-size: 10px; color: #666; display: block; border-top: 1px solid #eee; margin-top: 2px; }
        .weighted-val { color: #0d6efd; font-weight: bold; }
    </style>
</head>
<body>
<div id="loading" class="loading-overlay"><div class="spinner-border text-primary"></div><div class="mt-2 fw-bold text-dark">ë°ì´í„° ë¶„ì„ ë° ê°€ì¤‘ì¹˜ ë¹„êµ ì—°ì‚° ì¤‘...</div></div>

<div class="container-fluid p-4">
    <div class="header-card">
        <h4 class="fw-bold text-primary mb-3">ğŸš€ PPS AI Intelligence</h4>
        
        <div class="github-config row g-3 align-items-center">
            <div class="col-md-4"><label class="fw-bold mb-1 small">ğŸ”‘ GitHub í† í°</label><input type="password" id="gh_token" class="form-control form-control-sm"></div>
            <div class="col-md-3"><label class="fw-bold mb-1 small">ğŸ“… í˜„ì¬ ì¬ê³  ì‹œì </label><input type="month" id="ref_month" class="form-control form-control-sm"></div>
            <div class="col-md-5 d-flex gap-2 align-items-end">
                <button class="btn btn-dark btn-sm fw-bold w-100" onclick="saveToGithub()">ğŸ’¾ ì›”ë³„ê³„íš ì €ì¥</button>
                <button class="btn btn-outline-dark btn-sm fw-bold w-100" onclick="loadFromGithub()">ğŸ“‚ ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-4"><label class="fw-bold">1. íŒë§¤ ë°ì´í„° (ë©€í‹°)</label><input type="file" id="f_sales" class="form-control form-control-sm" multiple></div>
            <div class="col-md-4"><label class="fw-bold">2. í˜„ì¬ ì¬ê³  ë°ì´í„°</label><input type="file" id="f_stock" class="form-control form-control-sm"></div>
            <div class="col-md-4"><label class="fw-bold text-primary">3. ì‘ì—…ì¥ ë§ˆìŠ¤í„° (Fêµ¬ë¶„)</label><input type="file" id="f_wp" class="form-control form-control-sm"></div>
        </div>

        <div class="row g-2 align-items-center p-2 bg-light rounded border">
            <div class="col-auto">ğŸ‡¨ğŸ‡³ ì¤‘êµ­: <input type="number" id="cfg_china" style="width:45px;" value="2.0"></div>
            <div class="col-auto">ğŸ¢ ë³¸ì‚¬: <input type="number" id="cfg_other" style="width:45px;" value="0.5"></div>
            <div class="col-auto">ğŸ“‰ ìµœì†ŒíŒë§¤: <input type="number" id="cfg_min_limit" style="width:40px;" value="1"></div>
            <div class="col-auto ms-2 border-start ps-3"><label class="fw-bold text-danger small">ğŸš¨ ê¸´ê¸‰ ê¸°ì¤€:</label><input type="number" id="cfg_urgent_limit" style="width:45px;" value="0.3" step="0.1"></div>
            <div class="col-auto ms-auto"><button class="btn btn-primary btn-sm fw-bold" onclick="runAnalysis()">ğŸ“Š ì „ì²´ ë°ì´í„° ë¶„ì„ ì‹¤í–‰</button></div>
        </div>
    </div>

    <ul class="nav nav-tabs mb-3" id="planTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#stock-pane" type="button" onclick="resetLimits()">ğŸ“Š ì™„ì œí’ˆ í˜„ì¬ê³  ëª¨ë‹ˆí„°ë§</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#monthly-pane" type="button" onclick="resetLimits()">ğŸ“… ì›”ë³„ í™•ì • ê³„íš ìˆ˜ë¦½</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#annual-pane" type="button" onclick="resetLimits(); renderAnnual();">ğŸ“ˆ ì—°ê°„ ì˜ˆì¸¡ ì‹œë®¬ë ˆì´ì…˜</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="stock-pane">
            <div class="row mb-3 align-items-center bg-white p-2 rounded shadow-sm mx-0">
                <div class="col-md-2"><label class="fw-bold small">ì‘ì—…ì¥</label><select id="s_sel_wp" class="form-select form-select-sm" onchange="renderStock()"><option value="ALL">ì „ì²´</option></select></div>
                <div class="col-md-2"><label class="fw-bold small">ì˜ë¢°êµ¬ë¶„</label><select id="s_sel_cat" class="form-select form-select-sm" onchange="renderStock()"><option value="ALL">ì „ì²´</option><option value="ê³„íš">ê³„íšê±´</option><option value="ì£¼ë¬¸">ì£¼ë¬¸ê±´</option></select></div>
                <div class="col-md-2"><label class="fw-bold small text-danger">ìƒíƒœ</label><select id="s_sel_status" class="form-select form-select-sm" onchange="renderStock()"><option value="ALL">ì „ì²´</option><option value="ğŸš¨ê¸´ê¸‰">ğŸš¨ê¸´ê¸‰</option><option value="âš ï¸ì£¼ì˜">âš ï¸ì£¼ì˜</option><option value="ì •ìƒ">ì •ìƒ</option></select></div>
                <div class="col-md-6 d-flex gap-2 ms-auto justify-content-end">
                    <div class="summary-box text-success">ì¬ê³  ì´ì•¡: <span id="s_total_amt">0</span> ì›</div>
                    <div class="summary-box text-danger">ê¸´ê¸‰ í’ˆëª©: <span id="s_urgent_cnt">0</span> ê±´</div>
                </div>
            </div>
            <div class="table-container">
                <table class="table table-hover align-middle mb-0">
                    <thead><tr><th class="sticky-col">ìƒíƒœ</th><th>ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ê·œê²©</th><th>ë‹¨ê°€</th><th>ì‘ì—…ì¥</th><th>êµ¬ë¶„</th><th class="table-info">í˜„ì¬ê³ </th><th class="table-info">ì¬ê³ ê¸ˆì•¡</th><th class="bg-warning text-dark">ê°€ì¤‘í‰ê· (vsë‹¨ìˆœ)</th><th>ì•ˆì „ì¬ê³ </th></tr></thead>
                    <tbody id="stock_body"></tbody>
                </table>
                <button id="stock_load_more" class="load-more-btn" onclick="loadMore('stock')">ë°ì´í„° 50ê°œ ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>

        <div class="tab-pane fade" id="monthly-pane">
            <div class="row mb-3 align-items-center">
                <div class="col-md-3">
                    <div class="month-selector"><button class="btn-month" onclick="changeMonth(-1)">â—€</button><div id="month_display" class="month-display">ì„ íƒì•ˆë¨</div><button class="btn-month" onclick="changeMonth(1)">â–¶</button><input type="month" id="plan_month" style="display:none;" onchange="syncMonthDisplay()"></div>
                </div>
                <div class="col-md-2"><select id="m_sel_wp" class="form-select form-select-sm" onchange="renderMonthly()"></select></div>
                <div class="col-md-2"><select id="m_sel_cat" class="form-select form-select-sm" onchange="renderMonthly()"><option value="ALL">ì „ì²´ êµ¬ë¶„</option><option value="ê³„íš">ê³„íšê±´</option><option value="ì£¼ë¬¸">ì£¼ë¬¸ê±´</option></select></div>
                <div class="col-md-3 d-flex gap-2">
                    <div class="summary-box text-primary small">ìˆ˜ëŸ‰: <span id="m_sum_qty">0</span> EA</div>
                    <div class="summary-box text-success small">ê¸ˆì•¡: <span id="m_sum_amt">0</span> ì›</div>
                </div>
                <div class="col-md-2 text-end"><button class="btn btn-success fw-bold btn-sm w-100" onclick="downloadMonthly()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button></div>
            </div>
            <div class="table-container">
                <table class="table table-hover align-middle mb-0">
                    <thead><tr><th class="sticky-col">ì‚­ì œ</th><th>ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ê·œê²©</th><th>ë‹¨ê°€</th><th>êµ¬ë¶„</th><th class="table-info">í˜„ì¬ê³ </th><th class="bg-warning text-dark">ê°€ì¤‘í‰ê· (vsë‹¨ìˆœ)</th><th class="text-danger">ë¯¸ë˜ì†Œì§„</th><th>ì•ˆì „ì¬ê³ </th><th class="table-warning">ì ì •ì¬ê³ </th><th class="table-warning">ê¸°ì…ê³ (GH)</th><th class="table-primary">ìµœì¢…ê³„íš</th><th>ê³„íšê¸ˆì•¡</th></tr></thead>
                    <tbody id="monthly_body"></tbody>
                </table>
                <button id="monthly_load_more" class="load-more-btn" onclick="loadMore('monthly')">ë°ì´í„° 50ê°œ ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>

        <div class="tab-pane fade" id="annual-pane">
            <div class="row mb-3 align-items-center">
                <div class="col-md-2"><select id="a_sel_wp" class="form-select form-select-sm" onchange="renderAnnual()"></select></div>
                <div class="col-md-2"><select id="a_sel_cat" class="form-select form-select-sm" onchange="renderAnnual()"><option value="ALL">ì „ì²´ êµ¬ë¶„</option><option value="ê³„íš">ê³„íšê±´</option><option value="ì£¼ë¬¸">ì£¼ë¬¸ê±´</option></select></div>
                <div class="col-md-6 d-flex gap-2">
                    <div class="summary-box">ì—°ê°„ ìˆ˜ëŸ‰: <span id="a_sum_qty">0</span> EA</div>
                    <div class="summary-box text-success">ì—°ê°„ ê¸ˆì•¡: <span id="a_sum_amt">0</span> ì›</div>
                </div>
                <div class="col-md-2 text-end"><button class="btn btn-primary fw-bold btn-sm w-100" onclick="downloadAnnual()">ğŸ“¥ ì—°ê°„ ë‹¤ìš´ë¡œë“œ</button></div>
            </div>
            <div class="table-container">
                <table class="table table-hover table-bordered mb-0" style="min-width:1600px;"><thead id="annual_head"></thead><tbody id="annual_body"></tbody></table>
                <button id="annual_load_more" class="load-more-btn" onclick="loadMore('annual')">ë°ì´í„° 50ê°œ ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let rawData = { master: new Map(), salesByYear: {}, stock: {}, fullStockItems: [] };
let processedData = []; 
let annualData = [];
let displayLimits = { stock: 50, monthly: 50, annual: 50 }; 
const REPO_PATH = "bschoi-4126/plan";

window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('gh_token').value = localStorage.getItem('jemini_gh_token') || "";
    document.getElementById('ref_month').value = localStorage.getItem('jemini_ref_month') || new Date().toISOString().substring(0, 7);
    const pm = localStorage.getItem('jemini_plan_month') || new Date().toISOString().substring(0, 7);
    document.getElementById('plan_month').value = pm;
    syncMonthDisplay();

    document.getElementById('gh_token').addEventListener('input', (e) => localStorage.setItem('jemini_gh_token', e.target.value));
    document.getElementById('ref_month').addEventListener('input', (e) => localStorage.setItem('jemini_ref_month', e.target.value));
});

function syncMonthDisplay() {
    const val = document.getElementById('plan_month').value;
    const display = document.getElementById('month_display');
    if(display) display.innerText = val || "ì„ íƒì•ˆë¨";
    localStorage.setItem('jemini_plan_month', val);
    if(rawData.master.size > 0) reCalculate();
}

function changeMonth(diff) {
    const el = document.getElementById('plan_month');
    let d = new Date((el.value || new Date().toISOString().substring(0, 7)) + "-01");
    d.setMonth(d.getMonth() + diff);
    el.value = d.toISOString().substring(0, 7);
    syncMonthDisplay();
}

function resetLimits() { displayLimits = { stock: 50, monthly: 50, annual: 50 }; }
function loadMore(type) {
    displayLimits[type] += 100;
    if(type === 'stock') renderStock(true);
    else if(type === 'monthly') renderMonthly(true);
    else if(type === 'annual') renderAnnual(true);
}

async function runAnalysis() {
    const fSales = document.getElementById('f_sales').files;
    const fStock = document.getElementById('f_stock').files[0];
    const fWp = document.getElementById('f_wp').files[0];
    if(!fSales.length || !fStock || !fWp) return;

    document.getElementById('loading').style.display = 'flex';
    try {
        const wpRaw = await readExcel(fWp);
        const stockRaw = await readExcel(fStock);
        
        rawData.stock = {}; rawData.fullStockItems = [];
        stockRaw.slice(2).forEach(row => {
            const code = String(row[1] || "").trim();
            if(!code || code === "í’ˆëª©ì½”ë“œ") return;
            const amt = Number(String(row[13] || "0").replace(/,/g, "")) || 0;
            const qty = Number(String(row[16] || "0").replace(/,/g, "")) || 0;
            const price = Number(String(row[14] || "0").replace(/,/g, "")) || 0;
            const itemObj = { code, price, qty, amt, name: String(row[2] || "").trim(), spec: String(row[3] || "").trim() };
            rawData.stock[code] = itemObj; rawData.fullStockItems.push(itemObj);
        });

        rawData.salesByYear = {};
        for(let f of fSales) {
            const year = (f.name.match(/\d{4}/) || ["2025"])[0];
            const sRaw = await readExcel(f);
            if(!rawData.salesByYear[year]) rawData.salesByYear[year] = {};
            for(let i=0; i<sRaw.length; i++){
                if(String(sRaw[i][5]).includes("ìƒì‚°ì…ê³ ëŸ‰")) {
                    const code = String(sRaw[i][1]).trim();
                    const nextRow = sRaw[i+1];
                    if(code && nextRow && String(nextRow[5]).includes("ë§¤ì¶œëŸ‰")) {
                        rawData.salesByYear[year][code] = [6,8,10,12,14,16,18,20,22,24,26,28].map(idx => Number(String(nextRow[idx] || "0").replace(/,/g, "")) || 0);
                    }
                }
            }
        }

        rawData.master = new Map();
        let lastWp = "ë¯¸ì§€ì •";
        wpRaw.slice(6).forEach(row => {
            if(row[3]) lastWp = String(row[3]).trim();
            const code = String(row[7] || "").trim();
            const category = String(row[5] || "").trim() === "ê³„íš" ? "ê³„íš" : "ì£¼ë¬¸";
            if(code && code !== "í’ˆëª©ì½”ë“œ") {
                rawData.master.set(code, { code, wp: lastWp, category, name: String(row[8] || "").trim(), spec: String(row[9] || "").trim() });
            }
        });

        await reCalculate();
    } catch(e) { console.error(e); }
    document.getElementById('loading').style.display = 'none';
}

async function reCalculate() {
    const refM = document.getElementById('ref_month').value;
    const planM = document.getElementById('plan_month').value;
    const cRatio = parseFloat(document.getElementById('cfg_china').value) || 2.0;
    const oRatio = parseFloat(document.getElementById('cfg_other').value) || 0.5;
    const minLimit = parseFloat(document.getElementById('cfg_min_limit').value) || 1;
    const urgentLimit = parseFloat(document.getElementById('cfg_urgent_limit').value) || 0.3;

    const timeline = planM ? await getTimelineGap(refM, planM) : { gap: 0, pendingMap: {} };

    processedData = [];
    const allCodes = [...new Set([...rawData.fullStockItems.map(i=>i.code), ...rawData.master.keys()])];

    allCodes.forEach(code => {
        const s = rawData.stock[code] || { price: 0, qty: 0, amt: 0, name: "", spec: "" };
        const m = rawData.master.get(code) || { code, wp: "ê¸°íƒ€", category: "ì£¼ë¬¸", name: s.name, spec: s.spec };
        
        let weightedSum = 0, weightTotal = 0, simpleSum = 0, monthCount = 0;
        Object.keys(rawData.salesByYear).sort().forEach((year, idx) => {
            const weight = idx + 1; // 2020:1, 2021:2...
            const monthly = rawData.salesByYear[year][code] || Array(12).fill(0);
            const yearSum = monthly.reduce((a,b)=>a+b, 0);
            weightedSum += (yearSum / 12) * weight;
            weightTotal += weight;
            simpleSum += (yearSum / 12);
            monthCount++;
        });
        
        const weightedAvg = weightTotal > 0 ? Math.round(weightedSum / weightTotal) : 0;
        const simpleAvg = monthCount > 0 ? Math.round(simpleSum / monthCount) : 0;

        const ratio = m.wp.includes("ì¤‘êµ­") ? cRatio : oRatio;
        const target = Math.ceil(weightedAvg * (ratio + 1));
        const safety = Math.ceil(weightedAvg * ratio);
        const burn = weightedAvg * Math.max(0, timeline.gap - 1);
        const pending = timeline.pendingMap[code] || 0;

        const effectiveStock = (m.category === "ì£¼ë¬¸") ? 0 : s.qty;
        const plan = Math.max(0, (target + burn) - (effectiveStock + pending));

        processedData.push({ 
            ...m, name: s.name || m.name || "ë¯¸ë“±ë¡", spec: s.spec || m.spec || "-",
            price: s.price, stock: s.qty, stockAmt: s.amt, 
            avg: weightedAvg, simpleAvg: simpleAvg, 
            burn, safety, target, pending, planQty: plan, 
            status: (s.qty < weightedAvg * urgentLimit) ? "ğŸš¨ê¸´ê¸‰" : (s.qty < safety ? "âš ï¸ì£¼ì˜" : "ì •ìƒ"), 
            minLimitMet: (weightedAvg >= minLimit) 
        });
    });

    updateFilters(); renderStock(); renderMonthly(); calculateAnnual();
}

function renderStock(isLoadMore = false) {
    const wpF = document.getElementById('s_sel_wp')?.value || "ALL";
    const catF = document.getElementById('s_sel_cat')?.value || "ALL";
    const statF = document.getElementById('s_sel_status')?.value || "ALL";
    const body = document.getElementById('stock_body');
    if(!body) return;
    if(!isLoadMore) { body.innerHTML = ""; displayLimits.stock = 50; }
    
    const filtered = processedData.filter(d => d.stock > 0 && (wpF === "ALL" || d.wp === wpF) && (catF === "ALL" || d.category === catF) && (statF === "ALL" || d.status.includes(statF)));
    const toRender = filtered.slice(isLoadMore ? displayLimits.stock - 100 : 0, displayLimits.stock);
    
    let tAmt = 0, uCnt = 0;
    filtered.forEach(d => { tAmt += d.stockAmt; if(d.status.includes("ğŸš¨")) uCnt++; });
    document.getElementById('s_total_amt').innerText = tAmt.toLocaleString();
    document.getElementById('s_urgent_cnt').innerText = uCnt.toLocaleString();

    toRender.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="sticky-col">${d.status.includes("ğŸš¨") ? '<span class="badge-urgent">ğŸš¨ê¸´ê¸‰</span>' : d.status}</td>
            <td class="group-set">${d.code}</td><td>${d.name}</td><td>${d.spec}</td><td class="text-end">${d.price.toLocaleString()} ì›</td><td>${d.wp}</td><td>${d.category}</td>
            <td class="fw-bold">${d.stock.toLocaleString()} EA</td><td class="text-success">${d.stockAmt.toLocaleString()} ì›</td>
            <td><span class="weighted-val">${d.avg}</span><span class="compare-box">ë‹¨ìˆœ:${d.simpleAvg}</span></td>
            <td class="fw-bold">${d.safety}</td>`;
        body.appendChild(tr);
    });
    document.getElementById('stock_load_more').style.display = filtered.length > displayLimits.stock ? 'block' : 'none';
}

function renderMonthly(isLoadMore = false) {
    const wpF = document.getElementById('m_sel_wp')?.value || "ALL";
    const catF = document.getElementById('m_sel_cat')?.value || "ALL";
    const body = document.getElementById('monthly_body');
    if(!body) return;
    if(!isLoadMore) { body.innerHTML = ""; displayLimits.monthly = 50; }

    const filtered = processedData.filter(d => d.minLimitMet && (wpF === "ALL" || d.wp === wpF) && (catF === "ALL" || d.category === catF));
    const toRender = filtered.slice(isLoadMore ? displayLimits.monthly - 100 : 0, displayLimits.monthly);
    
    let tQ = 0, tA = 0;
    filtered.forEach(d => { tQ += d.planQty; tA += (d.planQty * d.price); });
    document.getElementById('m_sum_qty').innerText = tQ.toLocaleString();
    document.getElementById('m_sum_amt').innerText = tA.toLocaleString();

    toRender.forEach((d, idx) => {
        const tr = document.createElement('tr');
        if(d.category === "ì£¼ë¬¸") tr.className = "order-row";
        tr.innerHTML = `
            <td class="sticky-col"><button class="btn btn-outline-danger btn-sm" onclick="deleteItem(${idx})">Ã—</button></td>
            <td class="group-set">${d.code}</td><td>${d.name}</td><td>${d.spec}</td><td class="text-end">${d.price.toLocaleString()}</td><td>${d.category}</td>
            <td class="fw-bold">${d.stock.toLocaleString()}</td>
            <td><span class="weighted-val">${d.avg}</span><span class="compare-box">ë‹¨ìˆœ:${d.simpleAvg}</span></td>
            <td class="text-danger fw-bold">${d.burn}</td><td class="fw-bold">${d.safety}</td><td class="fw-bold text-primary">${d.target}</td><td class="text-success fw-bold">${d.pending}</td>
            <td><input type="number" style="text-align:center; width:60px;" value="${d.planQty}" onchange="updateM(${idx}, this.value)"></td>
            <td class="text-end fw-bold">${(d.planQty * d.price).toLocaleString()} ì›</td>`;
        body.appendChild(tr);
    });
    document.getElementById('monthly_load_more').style.display = filtered.length > displayLimits.monthly ? 'block' : 'none';
}

function renderAnnual(isLoadMore = false) {
    const wpF = document.getElementById('a_sel_wp')?.value || "ALL";
    const catF = document.getElementById('a_sel_cat')?.value || "ALL";
    const head = document.getElementById('annual_head');
    const body = document.getElementById('annual_body');
    if(!body || !head) return;
    const start = new Date(document.getElementById('ref_month').value + "-01");

    if(!isLoadMore) {
        let hHtml = `<tr><th class="sticky-col">ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ê·œê²©</th><th>ì‘ì—…ì¥</th><th>êµ¬ë¶„</th><th>ê°€ì¤‘í‰ê· </th>`;
        for(let i=1; i<=12; i++) { let m = new Date(start); m.setMonth(start.getMonth() + i); hHtml += `<th>${m.getMonth()+1}ì›”</th>`; }
        hHtml += `<th>í•©ê³„</th></tr>`;
        head.innerHTML = hHtml; body.innerHTML = ""; displayLimits.annual = 50;
    }

    const filtered = annualData.filter(d => (wpF === "ALL" || d.wp === wpF) && (catF === "ALL" || d.category === catF));
    const toRender = filtered.slice(isLoadMore ? displayLimits.annual - 100 : 0, displayLimits.annual);
    
    let tQ = 0, tA = 0;
    filtered.forEach(d => { let sum = d.plans.reduce((a,b)=>a+b,0); tQ += sum; tA += (sum * d.price); });
    document.getElementById('a_sum_qty').innerText = tQ.toLocaleString();
    document.getElementById('a_sum_amt').innerText = tA.toLocaleString();

    toRender.forEach(d => {
        let sum = d.plans.reduce((a,b)=>a+b,0);
        let tr = document.createElement('tr');
        let bHtml = `<td class="sticky-col group-set">${d.code}</td><td class="text-start">${d.name}</td><td>${d.spec}</td><td>${d.wp}</td><td>${d.category}</td><td>${d.avg}</td>`;
        d.plans.forEach(p => bHtml += `<td>${p > 0 ? p.toLocaleString() : '-'}</td>`);
        bHtml += `<td class="fw-bold text-primary">${sum.toLocaleString()} EA</td>`;
        tr.innerHTML = bHtml; body.appendChild(tr);
    });
    document.getElementById('annual_load_more').style.display = filtered.length > displayLimits.annual ? 'block' : 'none';
}

function calculateAnnual() {
    const cRatio = parseFloat(document.getElementById('cfg_china').value) || 2.0;
    const oRatio = parseFloat(document.getElementById('cfg_other').value) || 0.5;
    annualData = [];
    processedData.forEach(p => {
        if(p.avg < 1 && p.stock < 1) return;
        let curStock = (p.category === "ì£¼ë¬¸") ? 0 : p.stock;
        let mPlans = [];
        const ratio = p.wp.includes("ì¤‘êµ­") ? cRatio : oRatio;
        const target = Math.ceil(p.avg * (ratio + 1));
        for(let i=1; i<=12; i++) {
            let needed = Math.max(0, target - (curStock - p.avg));
            mPlans.push(needed);
            curStock = (p.category === "ì£¼ë¬¸") ? 0 : (curStock - p.avg) + needed;
        }
        annualData.push({ ...p, plans: mPlans });
    });
}

async function getTimelineGap(refM, planM) {
    const token = document.getElementById('gh_token').value;
    const start = new Date(refM + "-01");
    const end = new Date(planM + "-01");
    const gap = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
    const pendingMap = {};
    if(token && gap > 0) {
        let current = new Date(start);
        while(current < end) {
            const mStr = current.toISOString().substring(0, 7);
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/data/plan_${mStr}.json`, { headers: { Authorization: `token ${token}` } });
                if(res.ok) { JSON.parse(decodeURIComponent(escape(atob((await res.json()).content)))).forEach(i => pendingMap[i.code] = (pendingMap[i.code] || 0) + (i.planQty || 0)); }
            } catch(e) {}
            current.setMonth(current.getMonth() + 1);
        }
    }
    return { gap, pendingMap };
}

function updateFilters() {
    const wps = [...new Set(processedData.map(d => d.wp))].sort();
    const opts = '<option value="ALL">ğŸ­ ì „ì²´ ì‘ì—…ì¥ ë³´ê¸°</option>' + wps.map(w => `<option value="${w}">${w}</option>`).join('');
    ['s_sel_wp', 'm_sel_wp', 'a_sel_wp'].forEach(id => {
        const el = document.getElementById(id);
        if(el) { const cur = el.value; el.innerHTML = opts; el.value = wps.includes(cur) ? cur : "ALL"; }
    });
}

function updateM(idx, val) { processedData[idx].planQty = Number(val); renderMonthly(); }
function deleteItem(idx) { if(confirm("ì œì™¸?")) { processedData.splice(idx, 1); renderMonthly(); } }

async function saveToGithub() {
    const t = document.getElementById('gh_token').value;
    const m = document.getElementById('plan_month').value;
    if(!t || !m) return alert("í† í°ê³¼ ê³„íšì›” í™•ì¸!");
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(processedData))));
    const path = `data/plan_${m}.json`;
    let sha = "";
    try {
        const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${path}`, { headers: { Authorization: `token ${t}` } });
        if(res.ok) sha = (await res.json()).sha;
    } catch(e) {}
    await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${path}`, { method: "PUT", headers: { Authorization: `token ${t}` }, body: JSON.stringify({ message: `${m} ì €ì¥`, content, sha }) });
    alert("âœ… GitHub ì €ì¥ ì™„ë£Œ!");
}

async function loadFromGithub() {
    const t = document.getElementById('gh_token').value;
    const m = document.getElementById('plan_month').value;
    const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/data/plan_${m}.json`, { headers: { Authorization: `token ${t}` } });
    if(res.ok) {
        processedData = JSON.parse(decodeURIComponent(escape(atob((await res.json()).content))));
        updateFilters(); renderStock(); renderMonthly();
    }
}

async function readExcel(file) {
    const d = await file.arrayBuffer();
    const wb = XLSX.read(d, {type: 'array'});
    return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1, defval: ""});
}

function downloadMonthly() {
    const d = processedData.filter(i => i.planQty > 0).map(i => ({ "ì‘ì—…ì¥": i.wp, "êµ¬ë¶„": i.category, "ì½”ë“œ": i.code, "í’ˆëª©ëª…": i.name, "ê·œê²©": i.spec, "ë‹¨ê°€": i.price, "í˜„ì¬ê³ ": i.stock, "ê°€ì¤‘í‰ê· ": i.avg, "ë‹¨ìˆœí‰ê· ": i.simpleAvg, "ì•ˆì „ì¬ê³ ": i.safety, "ì ì •ì¬ê³ ": i.target, "ìµœì¢…ê³„íš": i.planQty }));
    const ws = XLSX.utils.json_to_sheet(d);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ê³„íšì„œ");
    XLSX.writeFile(wb, `${document.getElementById('plan_month').value}_ê³„íšì„œ.xlsx`);
}

function downloadAnnual() {
    const d = annualData.filter(i => i.plans.reduce((a,b)=>a+b,0) > 0).map(i => {
        let o = { "ì‘ì—…ì¥": i.wp, "êµ¬ë¶„": i.category, "ì½”ë“œ": i.code, "í’ˆëª©ëª…": i.name, "ê·œê²©": i.spec, "ê°€ì¤‘í‰ê· ": i.avg };
        i.plans.forEach((p, idx) => o[`${idx+1}ì›”`] = p);
        o["ì—°ê°„í•©ê³„"] = i.plans.reduce((a,b)=>a+b,0);
        return o;
    });
    const ws = XLSX.utils.json_to_sheet(d);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ì—°ê°„ê³„íš");
    XLSX.writeFile(wb, "ì—°ê°„_ì˜ˆì¸¡_ì‹œë®¬ë ˆì´ì…˜.xlsx");
}
</script>
</body>
</html>
