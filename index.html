<!DOCTYPE html>
<html lang="ko">
<head>
        <meta charset="UTF-8">
        <title>PPS AI Intelligence V41</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
                body { background-color: #f4f7fa; font-family: 'Pretendard', sans-serif; font-size: 11px; }
                .header-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 20px; }
                .github-config { background: #e7f5ff; padding: 15px; border-radius: 8px; border: 1px solid #74c0fc; margin-bottom: 15px; }
                .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); overflow: auto; max-height: 600px; position: relative; }
                .table thead th { background: #000 !important; color: #fff !important; text-align: center !important; vertical-align: middle !important; white-space: nowrap; position: sticky; top: 0; z-index: 20; border: 1px solid #333; font-weight: 700; cursor: pointer; }
                .table thead th:hover { background: #333 !important; text-decoration: underline; }
                .table td { text-align: center !important; vertical-align: middle !important; white-space: nowrap; border: 1px solid #dee2e6; }
                .sticky-col { position: sticky; left: 0; background: white !important; z-index: 10; border-right: 2px solid #dee2e6 !important; }
                .summary-box { background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6; font-weight: 800; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
                .nav-tabs .nav-link { font-weight: 800; color: #495057; border: none; padding: 12px 25px; cursor: pointer; }
                .nav-tabs .nav-link.active { color: #0d6efd !important; border-bottom: 4px solid #0d6efd !important; background: transparent !important; }
                .month-selector { display: flex; align-items: center; gap: 10px; background: #fff; padding: 5px 15px; border-radius: 8px; border: 2px solid #0d6efd; }
                .month-display { font-size: 14px; font-weight: 800; color: #0d6efd; min-width: 95px; text-align: center; }
                .btn-month { border: none; background: none; color: #0d6efd; font-size: 18px; font-weight: bold; cursor: pointer; }
                .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 400px; margin-bottom: 20px; }
                .loading-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:9999; justify-content:center; align-items:center; flex-direction:column; }
                .logic-switcher { background: #f1f3f5; padding: 5px; border-radius: 30px; display: inline-flex; border: 1px solid #ced4da; }
                .logic-btn { border: none; background: none; padding: 5px 15px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; }
                .logic-btn.active { background: #000; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
                input[type=number] { border: 1px solid #ced4da; border-radius: 4px; padding: 2px 5px; }
                input[type=number]::-webkit-inner-spin-button { opacity: 1; filter: contrast(150%) brightness(0.2); cursor: pointer; }
                .plan-input { width: 85px; text-align: center; font-weight: 800; background: #f8faff; border: 2px solid #0d6efd; }
                .load-more-container { text-align: center; padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; }
                .btn-load-more { padding: 8px 30px; font-weight: 800; font-size: 12px; border-radius: 20px; }
                .badge-urgent { background-color: #fa5252; color: white; padding: 3px 6px; border-radius: 4px; animation: blink 1.2s infinite; }
                @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
                .cache-status { font-size: 10px; font-weight: bold; color: #20c997; display: none; }
                .weighted-val { color: #0d6efd; font-weight: bold; }
        </style>
</head>
<body>

<div id="loading" class="loading-overlay"><div class="spinner-border text-primary"></div><div class="mt-3 fw-bold">ì˜ì—… ê³„íš ì—°ë™ ë° ë°ì´í„° ì •í•©ì„± ë¶„ì„ ì¤‘...</div></div>

<div class="container-fluid p-4">
        <div class="header-card">
                <h4 class="fw-bold text-primary mb-3">ğŸš€ PPS AI Intelligence V41</h4>
                <div class="github-config row g-3 align-items-center">
                        <div class="col-md-4"><label class="fw-bold mb-1 small">ğŸ”‘ GitHub Token</label><input type="password" id="gh_token" class="form-control form-control-sm"></div>
                        <div class="col-md-3"><label class="fw-bold mb-1 small">ğŸ“… ì‹¤ì¬ê³  ê¸°ì¤€ì›”</label><input type="month" id="ref_month" class="form-control form-control-sm"></div>
                        <div class="col-md-5 d-flex gap-2 align-items-end"><button class="btn btn-dark btn-sm w-100" onclick="saveToGithub()">ğŸ’¾ í˜„ì¬ ê³„íš ì €ì¥(í™•ì •)</button><button class="btn btn-outline-dark btn-sm w-100" onclick="loadFromGithub()">ğŸ“‚ ì €ì¥ëœ ê³„íš ë¡œë“œ</button></div>
                </div>
                <div class="row g-3 mb-3">
                        <div class="col-md-4"><label class="fw-bold small">1. ëˆ„ì  íŒë§¤</label><span id="status_sales" class="cache-status">(ì €ì¥ë¨ âœ…)</span><input type="file" id="f_sales" class="form-control form-control-sm" multiple></div>
                        <div class="col-md-4"><label class="fw-bold small">2. ì‹¤ì¬ê³ </label><span id="status_stock" class="cache-status">(ì €ì¥ë¨ âœ…)</span><input type="file" id="f_stock" class="form-control form-control-sm"></div>
                        <div class="col-md-4"><label class="fw-bold small text-primary">3. ë§ˆìŠ¤í„°</label><span id="status_master" class="cache-status">(ì €ì¥ë¨ âœ…)</span><input type="file" id="f_wp" class="form-control form-control-sm"></div>
                </div>
                <div class="row g-2 align-items-center p-2 bg-light rounded border">
                        <div class="col-auto">ğŸ‡¨ğŸ‡³ ì¤‘êµ­: <input type="number" id="cfg_china" style="width:45px;" value="2.0"></div>
                        <div class="col-auto ms-2">ğŸ¢ ë³¸ì‚¬: <input type="number" id="cfg_other" style="width:45px;" value="0.5"></div>
                        <div class="col-auto ms-2">ğŸ“‰ ìµœì†Œê¸°ì¤€(Min): <input type="number" id="cfg_min_limit" style="width:40px;" value="1"></div>
                        <div class="col-auto ms-2 border-start ps-3"><label class="fw-bold text-danger small">ğŸš¨ ê¸´ê¸‰ ê¸°ì¤€:</label><input type="number" id="cfg_urgent_limit" style="width:45px;" value="0.2" step="0.1"></div>
                        <div class="col-auto ms-auto d-flex gap-2">
                                <button class="btn btn-outline-danger btn-sm" onclick="clearLocalDB()">ğŸ—‘ï¸ ìºì‹œ ì‚­ì œ</button>
                                <button class="btn btn-primary btn-sm fw-bold px-4" onclick="runAnalysis()">ğŸ“Š ì „ì²´ ë°ì´í„° ë¶„ì„ ì‹¤í–‰</button>
                        </div>
                </div>
        </div>

        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#stock-pane" type="button" role="tab" onclick="resetLimits(); renderStock();">ğŸ“Š í˜„ì¬ê³ </button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#monthly-pane" type="button" role="tab" onclick="resetLimits(); renderMonthly();">ğŸ“… ê³„íš ìˆ˜ë¦½</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#annual-pane" type="button" role="tab" onclick="resetLimits(); renderAnnual();">ğŸ“ˆ ì—°ê°„ ì˜ˆì¸¡</button></li>
                <li class="nav-item"><button class="nav-link text-danger" data-bs-toggle="tab" data-bs-target="#dashboard-pane" type="button" role="tab" onclick="updateDashboardCharts()">ğŸ§  AI ì¸ì‚¬ì´íŠ¸</button></li>
                <li class="nav-item"><button class="nav-link text-success fw-bold" data-bs-toggle="tab" data-bs-target="#simulation-pane" type="button" role="tab">ğŸ§ª ì•Œê³ ë¦¬ì¦˜ ê²€ì¦</button></li>
        </ul>

        <div class="tab-content">
                <div class="tab-pane fade show active" id="stock-pane" role="tabpanel">
                        <div class="row mb-3 align-items-center bg-white p-2 rounded shadow-sm mx-0 text-center">
                                <div class="col-md-2"><select id="s_sel_wp" class="form-select form-select-sm" onchange="renderStock()"></select></div>
                                <div class="col-md-2"><select id="s_sel_cat" class="form-select form-select-sm" onchange="renderStock()"><option value="ALL">ì „ì²´ êµ¬ë¶„</option><option value="ê³„íš">ê³„íš</option><option value="ì„ì˜">ì„ì˜</option><option value="ì£¼ë¬¸">ì£¼ë¬¸</option></select></div>
                                <div class="col-md-2"><select id="s_sel_status" class="form-select form-select-sm" onchange="renderStock()"><option value="ALL">ì „ì²´ ìƒíƒœ</option><option value="ğŸš¨ê¸´ê¸‰">ğŸš¨ê¸´ê¸‰</option><option value="âš ï¸ì£¼ì˜">âš ï¸ì£¼ì˜</option><option value="ì •ìƒ">ì •ìƒ</option></select></div>
                                <div class="col-md-2 text-start"><div class="summary-box text-danger">ğŸš¨ ê¸´ê¸‰: <span id="s_urgent_cnt">0</span>ê±´</div></div>
                                <div class="col-md-4 d-flex gap-2 ms-auto justify-content-end"><div class="summary-box">ì¬ê³  ì´ì•¡: <span id="s_total_amt">0</span> ì›</div></div>
                        </div>
                        <div class="table-container">
                                <table class="table align-middle mb-0">
                                        <thead><tr><th onclick="sortTable('stock', 0)">ìƒíƒœ</th><th onclick="sortTable('stock', 1)">ì¶”ì²œ</th><th onclick="sortTable('stock', 2)">ì½”ë“œ</th><th onclick="sortTable('stock', 3)">í’ˆëª©ëª…</th><th onclick="sortTable('stock', 4)">ê·œê²©</th><th onclick="sortTable('stock', 5)">ë‹¨ê°€</th><th onclick="sortTable('stock', 6)">ì‘ì—…ì¥</th><th onclick="sortTable('stock', 7)">êµ¬ë¶„</th><th class="table-info" onclick="sortTable('stock', 8)">í˜„ì¬ê³ </th><th class="table-info" onclick="sortTable('stock', 9)">ê¸ˆì•¡</th><th class="bg-warning text-dark" onclick="sortTable('stock', 10)">í‰ê· </th><th onclick="sortTable('stock', 11)">ì•ˆì „</th></tr></thead>
                                        <tbody id="stock_body"></tbody>
                                </table>
                                <div class="load-more-container"><button class="btn btn-outline-dark btn-load-more" onclick="loadMore('stock')">+ ë°ì´í„° 50ê°œ ë” ë¶ˆëŸ¬ì˜¤ê¸°</button></div>
                        </div>
                </div>

                <div class="tab-pane fade" id="monthly-pane" role="tabpanel">
                        <div class="row mb-3 align-items-center text-center">
                                <div class="col-md-3"><div class="month-selector"><button class="btn-month" onclick="changeMonth(-1)">â—€</button><div id="month_display" class="month-display">ì„ íƒì•ˆë¨</div><button class="btn-month" onclick="changeMonth(1)">â–¶</button><input type="month" id="plan_month" style="display:none;" onchange="syncMonthDisplay()"></div></div>
                                <div class="col-md-3"><div class="logic-switcher"><button class="logic-btn active" id="btn_logic_v20" onclick="switchLogic('V20')">ê¸°ì¡´ ë¡œì§</button><button class="logic-btn" id="btn_logic_v21" onclick="switchLogic('V21')">ê³ ë„í™” ë¡œì§(AI)</button></div></div>
                                <div class="col-md-4 d-flex gap-2"><div class="summary-box text-primary" id="m_sum_qty_box">ìˆ˜ëŸ‰: 0 EA</div><div class="summary-box text-success" id="m_sum_amt_box">ê¸ˆì•¡: 0 ì›</div></div>
                                <div class="col-md-2"><button class="btn btn-success fw-bold btn-sm w-100" onclick="downloadMonthly()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button></div>
                        </div>
                        <div class="row mb-2 px-3 align-items-center"><div class="col-md-2"><select id="m_sel_wp" class="form-select form-select-sm" onchange="renderMonthly()"></select></div><div class="col-md-8 fw-bold text-muted small ps-3">* ì˜ì—…íŒ€ í™•ì •ë¶„ ì…ë ¥ ì‹œ í•´ë‹¹ ë‹¬ë¡œ ì´ë™ í›„ ìˆ˜ë™ ì…ë ¥ ë° ì €ì¥ì„ ìˆ˜í–‰í•˜ì„¸ìš”. ì¤‘êµ­(3ì›”), ë³¸ì‚¬(1ì›”) ì´í›„ ë°ì´í„°ëŠ” ì‹œìŠ¤í…œì´ ì œì•ˆí•©ë‹ˆë‹¤.</div></div>
                        <div class="table-container">
                                <table class="table align-middle mb-0">
                                        <thead>
                                                <tr>
                                                        <th>ì‚­ì œ</th><th onclick="sortTable('monthly', 1)">ì½”ë“œ</th><th onclick="sortTable('monthly', 2)">í’ˆëª©ëª…</th><th onclick="sortTable('monthly', 3)">ê·œê²©</th><th onclick="sortTable('monthly', 4)">ë‹¨ê°€</th>
                                                        <th onclick="sortTable('monthly', 5)">í˜„ì¬ê³ </th><th onclick="sortTable('monthly', 6)">í‰ê· </th><th onclick="sortTable('monthly', 7)">ìµœê·¼ 3ê°œì›”</th><th onclick="sortTable('monthly', 8)">ìµœì†ŒíŒë§¤</th><th onclick="sortTable('monthly', 9)">ìµœëŒ€íŒë§¤</th>
                                                        <th onclick="sortTable('monthly', 10)">ì†Œì§„</th><th onclick="sortTable('monthly', 11)">ì•ˆì „</th><th onclick="sortTable('monthly', 12)">ì ì •</th><th onclick="sortTable('monthly', 13)">í¬ì¥ë‹¨ìœ„</th><th onclick="sortTable('monthly', 14)">ê¸°ì…ê³ </th><th onclick="sortTable('monthly', 15)">ìµœì¢…ê³„íš</th><th onclick="sortTable('monthly', 16)">ê³„íšê¸ˆì•¡</th>
                                                </tr>
                                        </thead>
                                        <tbody id="monthly_body"></tbody>
                                </table>
                                <div class="load-more-container"><button class="btn btn-outline-dark btn-load-more" onclick="loadMore('monthly')">+ ë°ì´í„° 50ê°œ ë” ë¶ˆëŸ¬ì˜¤ê¸°</button></div>
                        </div>
                </div>

                <div class="tab-pane fade" id="annual-pane" role="tabpanel">
                        <div class="row mb-3 align-items-center text-center bg-white p-2 rounded shadow-sm mx-0">
                                <div class="col-md-2"><select id="a_sel_wp" class="form-select form-select-sm" onchange="renderAnnual()"></select></div>
                                <div class="col-md-2"><select id="a_sel_cat" class="form-select form-select-sm" onchange="renderAnnual()"><option value="ALL">ì „ì²´ êµ¬ë¶„</option><option value="ê³„íš">ê³„íš</option><option value="ì„ì˜">ì„ì˜</option><option value="ì£¼ë¬¸">ì£¼ë¬¸</option></select></div>
                                <div class="col-md-6 d-flex gap-2 ms-auto justify-content-end"><div class="summary-box" id="a_sum_qty_box">ì—°ê°„ ìˆ˜ëŸ‰: 0 EA</div><div class="summary-box text-success" id="a_sum_amt_box">ì—°ê°„ ê¸ˆì•¡: 0 ì›</div></div>
                        </div>
                        <div class="table-container">
                                <table class="table table-bordered mb-0" style="min-width:1600px;">
                                        <thead><tr id="annual_head_row"></tr></thead><tbody id="annual_body"></tbody>
                                </table>
                                <div class="load-more-container"><button class="btn btn-outline-dark btn-load-more" onclick="loadMore('annual')">+ ë°ì´í„° 50ê°œ ë” ë¶ˆëŸ¬ì˜¤ê¸°</button></div>
                        </div>
                </div>

                <div class="tab-pane fade" id="simulation-pane" role="tabpanel">
                        <div class="header-card border-success">
                                <h6 class="fw-bold text-success mb-3">ğŸ§ª ì•Œê³ ë¦¬ì¦˜ ì´ì¤‘ ê²€ì¦ (ì˜ì—… í™•ì • ê³„íš ê¸°ë°˜ ë°±í…ŒìŠ¤íŒ…)</h6>
                                <div class="row g-3 align-items-end">
                                        <div class="col-md-2"><label class="fw-bold small">ì—°ë„</label><select id="sim_year" class="form-select form-select-sm"><option value="2025">2025ë…„</option><option value="2024">2024ë…„</option><option value="2023">2023ë…„</option><option value="2022">2022ë…„</option><option value="2021">2021ë…„</option><option value="2020">2020ë…„</option></select></div>
                                        <div class="col-md-2"><label class="fw-bold small">ì‘ì—…ì¥</label><select id="sim_sel_wp" class="form-select form-select-sm" onchange="runAlgoSimulation()"></select></div>
                                        <div class="col-md-4"><label class="fw-bold small">ê¸°ì´ˆ ì¬ê³  íŒŒì¼</label><input type="file" id="f_sim_stock" class="form-control form-control-sm"></div>
                                        <div class="col-md-2"><button class="btn btn-success fw-bold w-100" onclick="runAlgoSimulation()">ğŸš€ ê²€ì¦ ê°€ë™</button></div>
                                </div>
                        </div>
                        <div class="row mt-3">
                                <div class="col-md-8"><div class="chart-container"><canvas id="simChart"></canvas></div></div>
                                <div class="col-md-4">
                                        <div class="summary-box mb-2 text-secondary">ê¸°ì¡´ ë¡œì§ ì ì¤‘ë¥ : <span id="sim_accuracy_v20">--%</span></div>
                                        <div class="summary-box mb-2 text-primary" style="background:#e7f5ff; border:2px solid #0d6efd;">ê³ ë„í™” ë¡œì§ ì ì¤‘ë¥ : <span id="sim_accuracy_v21" style="font-size:24px;">--%</span></div>
                                        <div class="summary-box text-center bg-light">í’ˆì ˆ ìœ„ê¸°: <span id="sim_shortage" class="clickable-shortage text-danger">--</span>íšŒ</div>
                                </div>
                        </div>
                        <div class="table-container mt-4">
                                <table class="table table-bordered table-sm">
                                        <thead><tr class="table-dark"><th>ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ê·œê²©</th><th>ê¸°ì¡´ ê³„íší•©</th><th>AI ê³ ë„í™”í•©</th><th>ì‹¤ì œ ë§¤ì¶œí•©</th><th>ì ì¤‘ë¥ (ê¸°ì¡´)</th><th>ì ì¤‘ë¥ (AI)</th></tr></thead>
                                        <tbody id="sim_body"></tbody>
                                </table>
                                <div class="load-more-container"><button class="btn btn-outline-dark btn-load-more" onclick="loadMore('sim')">+ ë°ì´í„° 50ê°œ ë” ë¶ˆëŸ¬ì˜¤ê¸°</button></div>
                        </div>
                </div>

                <div class="tab-pane fade" id="dashboard-pane" role="tabpanel">
                        <div class="row">
                                <div class="col-md-6"><div class="chart-container"><h6 class="fw-bold">ì¬ê³  ê°€ì¹˜ ë“±ê¸‰ (ABC)</h6><canvas id="abcChart"></canvas></div></div>
                                <div class="col-md-6"><div class="chart-container"><h6 class="fw-bold">ì—°ê°„ ë§¤ì¶œ íë¦„ (ê¸ˆì•¡ ê¸°ì¤€)</h6><canvas id="seasonChart"></canvas></div></div>
                                <div class="col-md-12"><div class="chart-container"><h6 class="fw-bold">ì‘ì—…ì¥ë³„ ìƒì‚° ë¡œë“œ (ê¸ˆì•¡ ê¸°ì¤€)</h6><canvas id="loadChart"></canvas></div></div>
                        </div>
                </div>
        </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let rawData = { master: new Map(), salesByYear: {}, stock: {}, fullStockItems: [] };
let processedData = []; let annualData = []; let simResults = []; let shortageDetails = [];
let displayLimits = { stock: 50, monthly: 50, sim: 50, annual: 50 }; 
let sortState = { stock: { idx: -1, asc: true }, monthly: { idx: -1, asc: true }, sim: { idx: -1, asc: true }, annual: { idx: -1, asc: true } };
let charts = {};
let currentLogicMode = 'V20';
const REPO_PATH = "bschoi-4126/plan";

const DB_NAME = "PPS_DB_V41"; const STORE_NAME = "CachedFiles";
const openDB = () => new Promise((res, rej) => { const req = indexedDB.open(DB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(STORE_NAME); req.onsuccess = e => res(e.target.result); req.onerror = e => rej(e); });
async function saveToDB(k, v) { const db = await openDB(); const tx = db.transaction(STORE_NAME, "readwrite"); tx.objectStore(STORE_NAME).put(v, k); }
async function loadFromDB(k) { try { const db = await openDB(); return new Promise(res => { const r = db.transaction(STORE_NAME).objectStore(STORE_NAME).get(k); r.onsuccess = () => res(r.result); r.onerror = () => res(null); }); } catch(e) { return null; } }
async function clearLocalDB() { if(confirm("ìºì‹œë¥¼ ì‚­ì œí• ê¹Œìš”?")) { const db = await openDB(); db.transaction(STORE_NAME, "readwrite").objectStore(STORE_NAME).clear(); location.reload(); } }

window.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('gh_token').value = localStorage.getItem('jemini_gh_token') || "";
        document.getElementById('ref_month').value = localStorage.getItem('jemini_ref_month') || new Date().toISOString().substring(0, 7);
        document.getElementById('plan_month').value = localStorage.getItem('jemini_plan_month') || new Date().toISOString().substring(0, 7);
        syncMonthDisplay();
        const c_sales = await loadFromDB("sales"), c_stock = await loadFromDB("stock"), c_master = await loadFromDB("master");
        if(c_sales) { rawData.salesByYear = c_sales; document.getElementById('status_sales').style.display = 'inline'; }
        if(c_stock) { rawData.stock = c_stock.stock; rawData.fullStockItems = c_stock.items; document.getElementById('status_stock').style.display = 'inline'; }
        if(c_master) { rawData.master = new Map(Object.entries(c_master)); document.getElementById('status_master').style.display = 'inline'; }
        if(c_sales && c_stock && c_master) reCalculate();
});

async function readExcel(file) { const buffer = await file.arrayBuffer(); const wb = XLSX.read(buffer, {type: 'array', cellDates: true}); return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1, defval: ""}); }
function syncMonthDisplay() { const v = document.getElementById('plan_month').value; if(document.getElementById('month_display')) document.getElementById('month_display').innerText = v || "ì„ íƒì•ˆë¨"; localStorage.setItem('jemini_plan_month', v); }
function changeMonth(diff) { const el = document.getElementById('plan_month'); let d = new Date((el.value || new Date().toISOString().substring(0, 7)) + "-01"); d.setMonth(d.getMonth() + diff); el.value = d.toISOString().substring(0, 7); syncMonthDisplay(); if(rawData.master.size > 0) reCalculate(); }
function switchLogic(mode) { currentLogicMode = mode; document.getElementById('btn_logic_v20').classList.toggle('active', mode === 'V20'); document.getElementById('btn_logic_v21').classList.toggle('active', mode === 'V21'); renderMonthly(); }
function resetLimits() { displayLimits = { stock: 50, monthly: 50, sim: 50, annual: 50 }; }
function loadMore(type) { displayLimits[type] += 50; if(type==='stock') renderStock(); else if(type==='monthly') renderMonthly(); else if(type==='annual') renderAnnual(); else if(type==='sim') renderSimResults_Table(); }

async function runAnalysis() {
        const fS = document.getElementById('f_sales').files, fT = document.getElementById('f_stock').files[0], fW = document.getElementById('f_wp').files[0];
        document.getElementById('loading').style.display = 'flex';
        try {
                if(fT) { const sRaw = await readExcel(fT); rawData.stock = {}; rawData.fullStockItems = []; sRaw.slice(2).forEach(r => { if(!r[1]) return; const c = String(r[1]).trim(); const item = { code:c, price:Number(String(r[14]||"0").replace(/,/g,"")), qty:Number(String(r[16]||"0").replace(/,/g,"")), amt:Number(String(r[13]||"0").replace(/,/g,"")), name:String(r[2]||"").trim(), spec:String(r[3]||"").trim() }; rawData.stock[c] = item; rawData.fullStockItems.push(item); }); await saveToDB("stock", { stock: rawData.stock, items: rawData.fullStockItems }); }
                if(fS.length) { for(let f of fS) { const year = (f.name.match(/\d{4}/) || ["2025"])[0]; const raw = await readExcel(f); if(!rawData.salesByYear[year]) rawData.salesByYear[year] = {}; for(let i=0; i<raw.length; i++){ if(String(raw[i][5]).includes("ìƒì‚°ì…ê³ ëŸ‰")) { const c = String(raw[i][1]).trim(); const nextRow = raw[i+1]; if(c && nextRow && String(nextRow[5]).includes("ë§¤ì¶œëŸ‰")) rawData.salesByYear[year][c] = [6,8,10,12,14,16,18,20,22,24,26,28].map(idx => Number(String(nextRow[idx] || "0").replace(/,/g, "")) || 0); } } } await saveToDB("sales", rawData.salesByYear); }
                if(fW) { rawData.master = new Map(); let lastWp = "ê¸°íƒ€"; const raw = await readExcel(fW); raw.slice(6).forEach(r => { if(r[3]) lastWp = String(r[3]).trim(); const c = String(r[7] || "").trim(); if(!c) return; const cat = String(r[5]||"ì£¼ë¬¸").trim(); const unit = Number(String(r[10]||"10").replace(/,/g,"")) || 10; const ex = rawData.master.get(c); let finalCat = (ex && ex.category === "ê³„íš") ? "ê³„íš" : cat; rawData.master.set(c, { code:c, wp:lastWp, category:finalCat, name:String(r[8]||"").trim(), spec:String(r[9]||"").trim(), unit }); }); await saveToDB("master", Object.fromEntries(rawData.master)); }
                await reCalculate(); location.reload();
        } catch(e) { alert("ë¶„ì„ ì‹¤íŒ¨"); console.error(e); }
        finally { document.getElementById('loading').style.display = 'none'; }
}

async function reCalculate() {
        const cR = parseFloat(document.getElementById('cfg_china').value) || 2.0, oR = parseFloat(document.getElementById('cfg_other').value) || 0.5, uL = parseFloat(document.getElementById('cfg_urgent_limit').value) || 0.2;
        const tl = await getTimelineGap(document.getElementById('ref_month').value, document.getElementById('plan_month').value);
        processedData = []; const allCodes = [...new Set([...rawData.fullStockItems.map(i=>i.code), ...rawData.master.keys()])];
        allCodes.forEach(code => {
                const s = rawData.stock[code] || { price: 0, qty: 0, amt: 0, name: "", spec: "" }, m = rawData.master.get(code) || { code, wp: "ê¸°íƒ€", category: "ì£¼ë¬¸", name: s.name, spec: s.spec, unit: 10 };
                let wSum = 0, tW = 0, allSalesArr = []; const yrs = Object.keys(rawData.salesByYear).sort();
                yrs.forEach((yr, yrIdx) => { const weight = yrIdx + 1; const monthly = rawData.salesByYear[yr][code] || Array(12).fill(0); const meanYr = monthly.reduce((a,b)=>a+b,0)/12; const cleaned = monthly.map(v => (v > meanYr * 2.5 && v > 5) ? meanYr : v); wSum += (cleaned.reduce((a,b)=>a+b,0)/12)*weight; tW += weight; allSalesArr.push(...cleaned); });
                let r3 = []; const revYrs = [...yrs].reverse(); for(let y of revYrs) { const moD = [...rawData.salesByYear[y][code]||Array(12).fill(0)].reverse(); for(let v of moD) { r3.push(v); if(r3.length===3) break; } if(r3.length===3) break; }
                const wAvg = tW > 0 ? Math.round(wSum/tW) : 0, avg3m = r3.length ? Math.round(r3.reduce((a,b)=>a+b)/r3.length) : 0, minH = allSalesArr.length ? Math.min(...allSalesArr) : 0, maxH = allSalesArr.length ? Math.max(...allSalesArr) : 0;
                const cv = (allSalesArr.length ? Math.sqrt(allSalesArr.reduce((a,b)=>a+Math.pow(b-(allSalesArr.reduce((x,y)=>x+y)/allSalesArr.length),2),0)/allSalesArr.length) : 0) / (allSalesArr.reduce((a,b)=>a+b,0)/allSalesArr.length || 1);
                const baseR = m.wp.includes("ì¤‘êµ­") ? cR : oR;
                const tA = Math.ceil(wAvg*(baseR+1)), sA = Math.ceil(wAvg*baseR), tB = Math.ceil(wAvg*((baseR*(1+cv*0.5))+1)), sB = Math.ceil(wAvg*(baseR*(1+cv*0.5)));
                const burn = wAvg*Math.max(0, tl.gap-1), pend = tl.pendingMap[code]||0, sVal = (m.category==="ì£¼ë¬¸"?0:s.qty);
                const raw_A = (tA+burn)-(sVal+pend), raw_B = (tB+burn)-(sVal+pend);
                processedData.push({ ...m, name: s.name||m.name, spec: s.spec||m.spec, price: s.price, stock: s.qty, stockAmt: s.amt, avg: wAvg, avg3m, minS: minH, maxS: maxH, burn, safety_A: sA, target_A: tA, plan_A: (raw_A < m.unit) ? 0 : Math.floor(raw_A / m.unit)*m.unit, safety_B: sB, target_B: tB, plan_B: (raw_B < m.unit) ? 0 : Math.floor(raw_B / m.unit)*m.unit, pending: pend, status: (s.qty < wAvg*uL)?"ğŸš¨ê¸´ê¸‰":(s.qty < sA?"âš ï¸ì£¼ì˜":"ì •ìƒ") });
        });
        const wps = [...new Set(processedData.map(d => d.wp))].sort(); const opts = '<option value="ALL">ì „ì²´ ì‘ì—…ì¥</option>' + wps.map(w => `<option value="${w}">${w}</option>`).join(''); ['s_sel_wp', 'm_sel_wp', 'a_sel_wp', 'sim_sel_wp'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = opts; });
        renderStock(); renderMonthly(); calculateAnnual();
}

function renderStock() {
        const body = document.getElementById('stock_body'); body.innerHTML = "";
        const wpF = document.getElementById('s_sel_wp').value, catF = document.getElementById('s_sel_cat').value, statF = document.getElementById('s_sel_status').value;
        const f = processedData.filter(d => d.stock > 0 && (wpF==="ALL"||d.wp===wpF) && (catF==="ALL"||d.category.includes(catF)) && (statF==="ALL"||d.status.includes(statF)));
        document.getElementById('s_urgent_cnt').innerText = f.filter(d => d.status.includes("ğŸš¨")).length.toLocaleString();
        let tA = 0; f.forEach(d => tA += d.stockAmt); document.getElementById('s_total_amt').innerText = tA.toLocaleString();
        f.slice(0, displayLimits.stock).forEach(d => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="sticky-col">${d.status.includes("ğŸš¨")?'<span class="badge-urgent">ğŸš¨ê¸´ê¸‰</span>':d.status}</td><td></td><td>${d.code}</td><td>${d.name}</td><td>${d.spec}</td><td>${d.price.toLocaleString()}</td><td>${d.wp}</td><td>${d.category}</td><td class="fw-bold">${d.stock.toLocaleString()}</td><td class="text-success">${d.stockAmt.toLocaleString()}</td><td><span class="weighted-val">${d.avg.toLocaleString()}</span></td><td>${d.safety_A.toLocaleString()}</td>`; body.appendChild(tr); });
}

function renderMonthly() {
        const body = document.getElementById('monthly_body'); body.innerHTML = "";
        const wpF = document.getElementById('m_sel_wp').value;
        const minL = document.getElementById('cfg_min_limit') ? parseFloat(document.getElementById('cfg_min_limit').value) || 1 : 1;
        const f = processedData.filter(d => { if(d.wp === "ê¸°íƒ€") return false; if(wpF !== "ALL" && d.wp !== wpF) return false; if(d.wp.includes("ì¤‘êµ­")) return true; return d.category === "ê³„íš"; });
        let tQ = 0, tA = 0; f.forEach(d => { const p = (currentLogicMode === 'V20' ? d.plan_A : d.plan_B); tQ += p; tA += (p * d.price); });
        document.getElementById('m_sum_qty_box').innerText = `ìˆ˜ëŸ‰: ${tQ.toLocaleString()} EA`; document.getElementById('m_sum_amt_box').innerText = `ê¸ˆì•¡: ${tA.toLocaleString()} ì›`;
        f.slice(0, displayLimits.monthly).forEach(d => {
                const tr = document.createElement('tr'); const p = (currentLogicMode==='V20'?d.plan_A:d.plan_B), t = (currentLogicMode==='V20'?d.target_A:d.target_B), s = (currentLogicMode==='V20'?d.safety_A:d.safety_B);
                tr.innerHTML = `<td class="sticky-col"><button class="btn btn-outline-danger btn-sm" onclick="deleteItem('${d.code}')">Ã—</button></td><td>${d.code}</td><td>${d.name}</td><td>${d.spec}</td><td>${d.price.toLocaleString()}</td><td class="fw-bold">${d.stock.toLocaleString()}</td><td class="fw-bold">${d.avg.toLocaleString()}</td><td class="bg-info text-white">${d.avg3m.toLocaleString()}</td><td class="bg-success text-white">${d.minS.toLocaleString()}</td><td class="bg-success text-white">${d.maxS.toLocaleString()}</td><td class="text-danger fw-bold">${d.burn.toLocaleString()}</td><td>${s.toLocaleString()}</td><td>${t.toLocaleString()}</td><td class="bg-light">${d.unit.toLocaleString()}</td><td class="text-primary fw-bold">${d.pending.toLocaleString()}</td><td class="table-primary"><input type="number" class="plan-input" value="${p}" onchange="updatePlanQty('${d.code}', this.value)"></td><td class="fw-bold">${(p*d.price).toLocaleString()}</td>`;
                body.appendChild(tr);
        });
}

function updatePlanQty(c, v) { const it = processedData.find(d => d.code === c); if(it) { if(currentLogicMode==='V20') it.plan_A = Number(v); else it.plan_B = Number(v); renderMonthly(); } }
function calculateAnnual() { annualData = []; processedData.forEach(p => { if(p.avg < 1 && p.stock < 1) return; let curS = p.stock, mP = [], yS = 0; const target = (currentLogicMode==='V20'?p.target_A:p.target_B); for(let i=1; i<=12; i++) { let n = Math.max(0, target-(curS-p.avg)); const plan = (n < p.unit) ? 0 : Math.floor(n/p.unit)*p.unit; mP.push(plan); yS += plan; curS = (curS-p.avg)+plan; } annualData.push({ ...p, plans: mP, annualSum: yS }); }); renderAnnual(); }
function renderAnnual() {
        const head = document.getElementById('annual_head_row'), body = document.getElementById('annual_body'), wpF = document.getElementById('a_sel_wp').value, catF = document.getElementById('a_sel_cat').value, start = new Date(document.getElementById('ref_month').value + "-01");
        head.innerHTML = `<th class="sticky-col">ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ê·œê²©</th><th>í‰ê· </th>` + [...Array(12).keys()].map(i => { let m = new Date(start); m.setMonth(start.getMonth()+i+1); return `<th>${m.getMonth()+1}ì›”</th>`; }).join('') + `<th>í•©ê³„</th>`;
        body.innerHTML = ""; const f = annualData.filter(p => (wpF==="ALL"||p.wp===wpF) && (catF==="ALL"||p.category.includes(catF)));
        let tQ = 0, tA = 0; f.forEach(p => { tQ += p.annualSum; tA += (p.annualSum*p.price); }); document.getElementById('a_sum_qty_box').innerText = `ì—°ê°„ ìˆ˜ëŸ‰: ${tQ.toLocaleString()} EA`; document.getElementById('a_sum_amt_box').innerText = `ì—°ê°„ ê¸ˆì•¡: ${tA.toLocaleString()} ì›`;
        f.slice(0, displayLimits.annual).forEach(p => { let tr = document.createElement('tr'); tr.innerHTML = `<td class="sticky-col group-set">${p.code}</td><td class="text-start">${p.name}</td><td>${p.spec}</td><td>${p.avg.toLocaleString()}</td>` + p.plans.map(v => `<td>${v>0?v.toLocaleString():'-'}</td>`).join('') + `<td class="fw-bold text-primary">${p.annualSum.toLocaleString()}</td>`; body.appendChild(tr); });
}

async function runAlgoSimulation() {
        const f = document.getElementById('f_sim_stock').files[0], yr = document.getElementById('sim_year').value, wpF = document.getElementById('sim_sel_wp').value;
        if(!f) return alert("ê¸°ì´ˆ ì¬ê³  íŒŒì¼ í•„ìˆ˜"); document.getElementById('loading').style.display='flex';
        try {
                const raw = await readExcel(f), sMap = {}; raw.slice(2).forEach(r => { if(r[1]) sMap[String(r[1]).trim()] = Number(String(r[16]||"0").replace(/,/g,"")); });
                simResults = []; let tP_A = Array(12).fill(0), tP_B = Array(12).fill(0), tA = Array(12).fill(0), sC = 0;
                processedData.filter(d => { if(wpF!=="ALL" && d.wp!==wpF) return false; if(d.wp.includes("ì¤‘êµ­")) return true; return d.category === "ê³„íš"; }).forEach(d => {
                        let sA = sMap[d.code]||0, sB = sMap[d.code]||0, actS = rawData.salesByYear[yr]?(rawData.salesByYear[yr][d.code]||Array(12).fill(0)):Array(12).fill(0);
                        let pA_S = 0, pB_S = 0, a_S = 0, active = false;
                        actS.forEach((sold, i) => { const nA = Math.max(0, d.target_A-(sA-d.avg)), nB = Math.max(0, d.target_B-(sB-d.avg)), pA = (nA < d.unit)?0:Math.floor(nA/d.unit)*d.unit, pB = (nB < d.unit)?0:Math.floor(nB/d.unit)*d.unit; tP_A[i]+=pA; tP_B[i]+=pB; tA[i]+=sold; if(i>0){ pA_S+=pA; pB_S+=pB; a_S+=sold; } sA=(sA-sold)+pA; sB=(sB-sold)+pB; if(sB<0) sC++; if(pA>0||pB>0||sold>0) active=true; });
                        if(active) simResults.push({ code:d.code, name:d.name, spec:d.spec, planA:pA_S, planB:pB_S, actual:a_S, accA:a_S>0?Math.max(0, 100-(Math.abs(pA_S-a_S)/a_S*100)):0, accB:a_S>0?Math.max(0, 100-(Math.abs(pB_S-a_S)/a_S*100)):0 });
                });
                renderSimResults_Table(tP_A, tP_B, tA, sC);
        } finally { document.getElementById('loading').style.display='none'; }
}

function renderSimResults_Table(pA, pB, aD, sC) {
        const body = document.getElementById('sim_body'); body.innerHTML = "";
        simResults.sort((a,b)=>a.accB-b.accB).slice(0, displayLimits.sim).forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.code}</td><td>${r.name}</td><td>${r.spec}</td><td>${r.planA.toLocaleString()}</td><td>${r.planB.toLocaleString()}</td><td>${r.actual.toLocaleString()}</td><td>${Math.round(r.accA)}%</td><td class="text-primary fw-bold">${Math.round(r.accB)}%</td>`; body.appendChild(tr); });
        document.getElementById('sim_accuracy_v20').innerText = Math.round(simResults.reduce((a,b)=>a+b.accA,0)/(simResults.length||1))+"%";
        document.getElementById('sim_accuracy_v21').innerText = Math.round(simResults.reduce((a,b)=>a+b.accB,0)/(simResults.length||1))+"%";
        document.getElementById('sim_shortage').innerText = (sC||0).toLocaleString();
        if(charts.sim) charts.sim.destroy(); charts.sim = new Chart(document.getElementById('simChart').getContext('2d'), { type:'line', data:{ labels:['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'], datasets:[{label:'ê¸°ì¡´ ë¡œì§', data:pA, borderColor:'#dee2e6', fill:false},{label:'ê³ ë„í™” ë¡œì§(AI)', data:pB, borderColor:'#20c997', fill:false},{label:'ì‹¤ì œ ë§¤ì¶œ', data:aD, borderColor:'#0d6efd', borderDash:[5,5], fill:false}]}, options:{maintainAspectRatio:false} });
}

function sortTable(tab, idx) {
        let s = sortState[tab]; s.asc = (s.idx === idx) ? !s.asc : true; s.idx = idx;
        const comp = (a, b, k) => {
                let v1 = a[k], v2 = b[k]; if(k==='amt') { v1 = a.price * (currentLogicMode==='V20'?a.plan_A:a.plan_B); v2 = b.price * (currentLogicMode==='V20'?b.plan_A:b.plan_B); }
                if (typeof v1 === 'string') return s.asc ? v1.localeCompare(v2) : v2.localeCompare(v1); return s.asc ? v1 - v2 : v2 - v1;
        };
        if (tab === 'stock') { processedData.sort((a,b) => comp(a,b, ['status','','code','name','spec','price','wp','category','stock','stockAmt','avg','safety_A'][idx])); renderStock(); }
        else if (tab === 'monthly') { processedData.sort((a,b) => comp(a,b, ['','code','name','spec','price','stock','avg','avg3m','minS','maxS','burn','safety_A','target_A','unit','pending','plan_A','amt'][idx])); renderMonthly(); }
        else if (tab === 'sim') { simResults.sort((a,b) => comp(a,b, ['code','name','spec','planA','planB','actual','accA','accB'][idx])); renderSimResults_Table(); }
        else if (tab === 'annual') { annualData.sort((a,b) => comp(a,b, ['code','name','spec','avg','','','','','','','','','','','','annualSum'][idx] || 'annualSum')); renderAnnual(); }
}

function updateDashboardCharts() {
        const d = processedData.filter(i => i.wp !== "ê¸°íƒ€"); if(!d.length) return;
        const sorted = [...d].sort((a,b) => (b.avg*b.price)-(a.avg*a.price));
        let cA=0, cB=0, cC=0, cV=0, tV = sorted.reduce((s,i)=>s+(i.avg*i.price),0);
        sorted.forEach(i => { cV+=(i.avg*i.price); let r=(cV/tV)*100; if(r<=70) cA++; else if(r<=90) cB++; else cC++; });
        if(charts.abc) charts.abc.destroy(); charts.abc = new Chart(document.getElementById('abcChart').getContext('2d'), { type:'pie', data:{ labels:['A(70%)','B(20%)','C(10%)'], datasets:[{data:[cA,cB,cC], backgroundColor:['#fa5252','#fab005','#ced4da']}]}, options:{maintainAspectRatio:false} });
        let moA = Array(12).fill(0); Object.keys(rawData.salesByYear).forEach(y => { Object.entries(rawData.salesByYear[y]).forEach(([c, ms]) => { if(rawData.master.get(c)?.wp !== "ê¸°íƒ€") { const pr = rawData.stock[c]?.price || 0; ms.forEach((q,idx) => moA[idx] += (q * pr)); } }); });
        if(charts.season) charts.season.destroy(); 
        charts.season = new Chart(document.getElementById('seasonChart').getContext('2d'), { type:'line', data:{ labels:['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'], datasets:[{label:'ì´ë§¤ì¶œì•¡(ì›)', data:moA, borderColor:'#0d6efd', tension:0.3, fill:true, backgroundColor:'rgba(13, 110, 253, 0.1)'}]}, options:{maintainAspectRatio:false} });
        const load = {}; d.forEach(i => { const p = (currentLogicMode==='V20'?i.plan_A:i.plan_B); if(p>0) load[i.wp] = (load[i.wp]||0)+(p*i.price); });
        if(charts.load) charts.load.destroy(); charts.load = new Chart(document.getElementById('loadChart').getContext('2d'), { type:'bar', data:{ labels:Object.keys(load), datasets:[{label:'ìƒì‚°ë¡œë“œ(ì›)', data:Object.values(load), backgroundColor:'#20c997'}]}, options:{indexAxis:'y', maintainAspectRatio:false} });
}

async function getTimelineGap(r, p) { 
        const t = document.getElementById('gh_token').value; if(!t || !r || !p) return { gap: 0, pendingMap: {} }; 
        const s = new Date(r + "-01"), e = new Date(p + "-01"), gap = (e.getFullYear() - s.getFullYear()) * 12 + (e.getMonth() - s.getMonth()); 
        const pm = {}; if(gap > 0) { let c = new Date(s); while(c < e) { const m = c.toISOString().substring(0, 7); try { const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/data/plan_${m}.json`, { headers: { Authorization: `token ${t}` } }); if(res.ok) { const j = await res.json(); JSON.parse(decodeURIComponent(escape(atob(j.content)))).forEach(i => pm[i.code] = (pm[i.code]||0)+(i.planQty||0)); } } catch(ex){} c.setMonth(c.getMonth()+1); } } 
        return { gap, pendingMap: pm }; 
}

async function saveToGithub() {
        const t = document.getElementById('gh_token').value, m = document.getElementById('plan_month').value;
        if(!t || !m) return alert("GitHub ì •ë³´ í™•ì¸!");
        const wpF = document.getElementById('m_sel_wp').value;
        const target = processedData.filter(d => {
                if (d.wp === "ê¸°íƒ€") return false;
                if (wpF !== "ALL" && d.wp !== wpF) return false;
                if (d.wp.includes("ì¤‘êµ­")) return true;
                return d.category === "ê³„íš";
        }).map(d => ({ code: d.code, planQty: (currentLogicMode === 'V20' ? d.plan_A : d.plan_B) }));
        if(target.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(target))));
        const path = `data/plan_${m}.json`; let sha = "";
        try { const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${path}`, { headers: { Authorization: `token ${t}` } }); if(res.ok) sha = (await res.json()).sha; } catch(e) {}
        await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${path}`, { method: "PUT", headers: { Authorization: `token ${t}` }, body: JSON.stringify({ message: `${m} ê³„íš ì €ì¥`, content, sha }) });
        alert(`ì €ì¥ ì™„ë£Œ!`);
}

function loadFromGithub() {
        const t = document.getElementById('gh_token').value, m = document.getElementById('plan_month').value;
        fetch(`https://api.github.com/repos/${REPO_PATH}/contents/data/plan_${m}.json`, { headers: { Authorization: `token ${t}` } }).then(res => res.json()).then(data => {
                const loaded = JSON.parse(decodeURIComponent(escape(atob(data.content))));
                loaded.forEach(ld => { const target = processedData.find(pd => pd.code === ld.code); if(target) { if(currentLogicMode === 'V20') target.plan_A = ld.planQty; else target.plan_B = ld.planQty; } });
                renderMonthly(); alert("ê¸°ì¡´ ê³„íš ë¡œë“œ ì™„ë£Œ!");
        }).catch(e => alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."));
}

function deleteItem(code) { if(confirm("ê³„íšì—ì„œ ì œì™¸?")) { const idx = processedData.findIndex(d => d.code === code); if(idx > -1) { processedData.splice(idx, 1); renderMonthly(); } } }
function downloadMonthly() {
        const wpF = document.getElementById('m_sel_wp').value;
        const f = processedData.filter(d => {
                if(d.wp === "ê¸°íƒ€") return false;
                if(wpF !== "ALL" && d.wp !== wpF) return false;
                const p = (currentLogicMode==='V20'?d.plan_A:d.plan_B);
                if(d.wp.includes("ì¤‘êµ­")) return p > 0;
                return d.category === "ê³„íš" && p > 0;
        });
        const exportData = f.map(i => ({ "ì½”ë“œ": i.code, "í’ˆëª©ëª…": i.name, "ê·œê²©": i.spec, "ë‹¨ê°€": i.price, "ê°€ì¤‘í‰ê· ": i.avg, "ìµœê·¼3ê°œì›”": i.avg3m, "í¬ì¥ë‹¨ìœ„": i.unit, "ìµœì¢…ê³„íš": (currentLogicMode==='V20'?i.plan_A:i.plan_B) }));
        const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ê³„íš");
        XLSX.writeFile(wb, `ê³„íš_${document.getElementById('plan_month').value}.xlsx`);
}
</script>
</body>
</html>
