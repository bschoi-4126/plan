<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒì‚° ê³„íš ìˆ˜ë¦½ ì‹œìŠ¤í…œ V12 (Final)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Pretendard', sans-serif; font-size: 12px; }
        .header-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .github-config { background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #90caf9; margin-bottom: 20px; }
        .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow-x: auto; max-height: 600px; }
        .table thead th { background: #2d3748; color: white; position: sticky; top: 0; z-index: 20; text-align: center; }
        .sticky-col { position: sticky; left: 0; background: white !important; z-index: 10; border-right: 2px solid #cbd5e0 !important; }
        .input-plan { width: 75px; text-align: center; border: 2px solid #4299e1; border-radius: 4px; font-weight: 800; }
        .summary-box { background: #fff; padding: 10px 20px; border-radius: 8px; border: 1px solid #dee2e6; font-weight: bold; }
    </style>
</head>
<body>
<div class="container-fluid p-4">
    <div class="header-card">
        <h4 class="fw-bold text-primary mb-3">ğŸ­ ìƒì‚° ê³„íš ìˆ˜ë¦½ ì‹œìŠ¤í…œ V12 (DB: bschoi-4126/plan)</h4>
        
        <div class="github-config row g-3 align-items-center">
            <div class="col-md-4">
                <label class="fw-bold mb-1">ğŸ”‘ GitHub í† í° (Personal Access Token)</label>
                <input type="password" id="gh_token" class="form-control form-control-sm" placeholder="ghp_ë¡œ ì‹œì‘í•˜ëŠ” í† í° ì…ë ¥">
            </div>
            <div class="col-md-2">
                <label class="fw-bold mb-1">ğŸ“… ê³„íšì›” ì„ íƒ</label>
                <input type="month" id="plan_month" class="form-control form-control-sm">
            </div>
            <div class="col-md-6 d-flex gap-2 align-items-end">
                <button class="btn btn-dark btn-sm fw-bold w-100" onclick="saveToGithub()">ğŸ’¾ í˜„ì¬ ê³„íš GitHub ì €ì¥</button>
                <button class="btn btn-outline-dark btn-sm fw-bold w-100" onclick="loadFromGithub()">ğŸ“‚ ê³¼ê±° ê³„íš ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
            <div class="small text-muted mt-1 px-3">* ì €ì¥ì†Œ: <strong>bschoi-4126/plan</strong> ê²½ë¡œì— íŒŒì¼ì´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div>
        </div>

        <div class="row g-3 mt-2">
            <div class="col-md-3"><label class="fw-bold">1. íŒë§¤ ë°ì´í„°</label><input type="file" id="f_sales" class="form-control" multiple></div>
            <div class="col-md-3"><label class="fw-bold">2. í˜„ì¬ ì¬ê³ </label><input type="file" id="f_stock" class="form-control"></div>
            <div class="col-md-3"><label class="fw-bold">3. ì‘ì—…ì¥ ë§ˆìŠ¤í„°</label><input type="file" id="f_wp" class="form-control"></div>
            <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100 fw-bold" onclick="runAnalysis()">ğŸ“Š ë°ì´í„° í†µí•© ë¶„ì„</button></div>
        </div>

        <div class="row g-3 align-items-center mt-3 p-3 bg-light rounded border">
            <div class="col-auto">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ ë°°ìœ¨: <input type="number" id="cfg_china" style="width:50px;" value="2.0"></div>
            <div class="col-auto">ğŸ¢ ë³¸ì‚¬ ë°°ìœ¨: <input type="number" id="cfg_other" style="width:50px;" value="0.5"></div>
            <div class="col-auto">ğŸ“‰ ìµœì†ŒíŒë§¤ëŸ‰: <input type="number" id="cfg_min_limit" style="width:50px;" value="1"></div>
            <div class="col-auto"><button class="btn btn-warning btn-sm fw-bold" onclick="reCalculate()">ğŸ”„ ì„¤ì • ì ìš©</button></div>
            <div class="col-auto ms-auto d-flex gap-1">
                <input type="text" id="add_code" placeholder="ì½”ë“œ" style="width:70px;">
                <input type="text" id="add_name" placeholder="í’ˆëª©ëª…" style="width:100px;">
                <select id="add_wp"><option value="ì¤‘êµ­ìƒì‚°">ì¤‘êµ­</option><option value="ë³¸ì‚¬">ë³¸ì‚¬</option></select>
                <button class="btn btn-info btn-sm fw-bold" onclick="addNewItem()">â• í’ˆëª© ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <div id="result_area" style="display:none;">
        <div class="row mb-3 align-items-center">
            <div class="col-md-2"><select id="sel_wp" class="form-select fw-bold border-primary" onchange="renderDisplay()"></select></div>
            <div class="col-md-7 d-flex gap-3">
                <div class="summary-box text-primary" id="sum_qty">ì´ ìˆ˜ëŸ‰: 0</div>
                <div class="summary-box text-success" id="sum_amt">ì´ ê¸ˆì•¡: 0</div>
            </div>
            <div class="col-md-3 text-end"><button class="btn btn-success fw-bold" onclick="downloadExcel()">ğŸ“¥ ìµœì¢… ê³„íšì„œ ë‹¤ìš´ë¡œë“œ(Excel)</button></div>
        </div>

        <div class="table-container">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th class="sticky-col">ì‚­ì œ</th>
                        <th>í’ˆëª©ì½”ë“œ</th><th>í’ˆëª©ëª…</th><th>ê·œê²©</th><th>ë‹¨ê°€</th><th>ì‘ì—…ì¥</th>
                        <th class="table-info">í˜„ì¬ê³ </th><th class="table-secondary">í‰ê· </th>
                        <th class="table-warning">ì ì •</th><th class="table-danger">ì…ê³ ì˜ˆì •</th>
                        <th class="table-primary">ê³„íšìˆ˜ëŸ‰</th><th class="table-primary">ê³„íšê¸ˆì•¡</th>
                    </tr>
                </thead>
                <tbody id="data_body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let rawData = { master: new Map(), sales: {}, stock: {} };
let processedData = [];
const REPO_PATH = "bschoi-4126/plan";

async function runAnalysis() {
    const fSales = document.getElementById('f_sales').files;
    const fStock = document.getElementById('f_stock').files[0];
    const fWp = document.getElementById('f_wp').files[0];
    if(!fSales.length || !fStock || !fWp) return alert("ëª¨ë“  íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.");

    try {
        const wpRaw = await readExcel(fWp);
        const stockRaw = await readExcel(fStock);
        
        rawData.stock = {};
        stockRaw.slice(2).forEach(row => {
            const code = String(row[1] || "").trim();
            if(code) rawData.stock[code] = { price: Number(row[14]) || 0, qty: Number(row[16]) || 0 };
        });

        rawData.sales = {};
        for(let f of fSales) {
            const sRaw = await readExcel(f);
            for(let i=0; i<sRaw.length; i++){
                if(String(sRaw[i][5]).includes("ìƒì‚°ì…ê³ ëŸ‰")) {
                    const code = String(sRaw[i][1]).trim();
                    const nextRow = sRaw[i+1];
                    if(code && nextRow && String(nextRow[5]).includes("ë§¤ì¶œëŸ‰")) {
                        if(!rawData.sales[code]) rawData.sales[code] = [];
                        [6,8,10,12,14,16,18,20,22,24,26,28].forEach(idx => {
                            let n = Number(String(nextRow[idx] || "0").replace(/,/g, ""));
                            if(!isNaN(n)) rawData.sales[code].push(n);
                        });
                    }
                }
            }
        }

        rawData.master = new Map();
        let lastWp = "ë¯¸ì§€ì •";
        wpRaw.slice(6).forEach(row => {
            if(row[3]) lastWp = String(row[3]).trim();
            const code = String(row[7] || "").trim();
            if(code && code !== "í’ˆëª©ì½”ë“œ" && !rawData.master.has(code)) {
                rawData.master.set(code, { code, wp: lastWp, name: row[8], spec: row[9] });
            }
        });

        reCalculate();
        document.getElementById('result_area').style.display = 'block';
        updateWpFilter();
        alert("ë¶„ì„ ì™„ë£Œ!");
    } catch(e) { console.error(e); alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
}

function reCalculate() {
    const cRatio = parseFloat(document.getElementById('cfg_china').value) || 2.0;
    const oRatio = parseFloat(document.getElementById('cfg_other').value) || 0.5;
    const minLimit = parseFloat(document.getElementById('cfg_min_limit').value) || 1;

    processedData = [];
    rawData.master.forEach((m, code) => {
        const s = rawData.stock[code] || { price: 0, qty: 0 };
        const hist = rawData.sales[code] || [];
        const avg = hist.length ? Math.round(hist.reduce((a,b)=>a+b,0)/hist.length) : 0;
        if(avg < minLimit) return;

        const ratio = m.wp.includes("ì¤‘êµ­") ? cRatio : oRatio;
        const target = Math.ceil(avg * (ratio + 1));
        const plan = Math.max(0, target - s.qty);
        processedData.push({ ...m, price: s.price, stock: s.qty, avg, target, pending: 0, planQty: plan });
    });
    renderDisplay();
}

function renderDisplay() {
    const wp = document.getElementById('sel_wp').value;
    const body = document.getElementById('data_body');
    body.innerHTML = "";
    let tQty = 0, tAmt = 0;

    processedData.filter(d => wp === "ALL" || d.wp === wp).forEach((d, idx) => {
        tQty += d.planQty; tAmt += (d.planQty * d.price);
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="sticky-col"><button class="btn btn-outline-danger btn-sm" onclick="deleteItem(${idx})">Ã—</button></td>
            <td>${d.code}</td><td class="text-start">${d.name}</td><td class="text-start">${d.spec}</td>
            <td class="text-end">${d.price.toLocaleString()}</td><td>${d.wp}</td>
            <td class="fw-bold">${d.stock.toLocaleString()}</td><td>${d.avg}</td>
            <td class="text-primary fw-bold">${d.target}</td>
            <td><input type="number" class="form-control form-control-sm text-center" value="${d.pending}" onchange="updateRow(${idx}, 'pending', this.value)"></td>
            <td><input type="number" class="input-plan" value="${d.planQty}" onchange="updateRow(${idx}, 'planQty', this.value)"></td>
            <td class="text-end fw-bold text-success">${(d.planQty * d.price).toLocaleString()}</td>
        `;
        body.appendChild(tr);
    });
    document.getElementById('sum_qty').innerText = `ì´ ìˆ˜ëŸ‰: ${tQty.toLocaleString()}`;
    document.getElementById('sum_amt').innerText = `ì´ ê¸ˆì•¡: ${tAmt.toLocaleString()}ì›`;
}

function updateRow(idx, field, val) {
    const d = processedData[idx];
    d[field] = Number(val);
    if(field === 'pending') d.planQty = Math.max(0, d.target - (d.stock + d.pending));
    renderDisplay();
}

function addNewItem() {
    const code = document.getElementById('add_code').value;
    const name = document.getElementById('add_name').value;
    const wp = document.getElementById('add_wp').value;
    if(!code || !name) return alert("ì½”ë“œì™€ í’ˆëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
    processedData.unshift({ code, name, wp, spec: "ìˆ˜ë™ì¶”ê°€", price: 0, stock: 0, avg: 0, target: 0, pending: 0, planQty: 0 });
    renderDisplay();
}

function deleteItem(idx) {
    if(confirm("í•´ë‹¹ í•­ëª©ì„ ê³„íšì—ì„œ ì œì™¸í• ê¹Œìš”?")) { processedData.splice(idx, 1); renderDisplay(); }
}

async function saveToGithub() {
    const token = document.getElementById('gh_token').value;
    const month = document.getElementById('plan_month').value;
    if(!token || !month) return alert("GitHub í† í°ê³¼ ê³„íšì›”ì„ ì…ë ¥í•˜ì„¸ìš”.");

    const path = `data/plan_${month}.json`;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(processedData))));
    let sha = "";
    try {
        const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${path}`, { headers: { Authorization: `token ${token}` } });
        if(res.ok) { const d = await res.json(); sha = d.sha; }
    } catch(e) {}

    const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${path}`, {
        method: "PUT", headers: { Authorization: `token ${token}` },
        body: JSON.stringify({ message: `${month} ê³„íš ì €ì¥`, content, sha })
    });
    if(res.ok) alert("GitHub ì €ì¥ ì™„ë£Œ!"); else alert("ì €ì¥ ì‹¤íŒ¨. í† í° ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
}

async function loadFromGithub() {
    const token = document.getElementById('gh_token').value;
    const month = document.getElementById('plan_month').value;
    const path = `data/plan_${month}.json`;
    const res = await fetch(`https://api.github.com/repos/${REPO_PATH}/contents/${path}`, { headers: { Authorization: `token ${token}` } });
    if(res.ok) {
        const d = await res.json();
        processedData = JSON.parse(decodeURIComponent(escape(atob(d.content))));
        document.getElementById('result_area').style.display = 'block';
        updateWpFilter(); renderDisplay();
        alert(`${month} ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    } else alert("í•´ë‹¹ ì›”ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
}

function updateWpFilter() {
    const wps = [...new Set(processedData.map(d => d.wp))].sort();
    const sel = document.getElementById('sel_wp');
    sel.innerHTML = '<option value="ALL">ì „ì²´ ì‘ì—…ì¥</option>' + wps.map(w => `<option value="${w}">${w}</option>`).join('');
}

async function readExcel(file) {
    const d = await file.arrayBuffer();
    const wb = XLSX.read(d, {type: 'array'});
    return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1, defval: ""});
}

function downloadExcel() {
    const exportData = processedData.map(d => ({
        "ì‘ì—…ì¥": d.wp, "í’ˆëª©ì½”ë“œ": d.code, "í’ˆëª©ëª…": d.name, "ê·œê²©": d.spec, "ë‹¨ê°€": d.price,
        "í˜„ì¬ê³ ": d.stock, "ì›”í‰ê· íŒë§¤": d.avg, "ì ì •ì¬ê³ ": d.target, "ì…ê³ ì˜ˆì •": d.pending, "ê³„íšìˆ˜ëŸ‰": d.planQty, "ê³„íšê¸ˆì•¡": d.planQty * d.price
    }));
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ìƒì‚°ê³„íšì„œ");
    XLSX.writeFile(wb, `${document.getElementById('plan_month').value || 'ê³„íš'}_ìƒì‚°ê³„íšì„œ.xlsx`);
}
</script>
</body>
</html>
